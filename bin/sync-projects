#!/bin/bash
set -e

CONFIG_FILE="$HOME/.config/sync-projects/env"
EXCLUDES_FILE="$HOME/.config/rclone/excludes.txt"
START_TIME=$(date +%s)

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Configuration file not found at $CONFIG_FILE"
    echo "Please create it with content like:"
    echo "LOCAL_DIR=\"$HOME/projects\""
    echo "CLOUD_DIR=\"$HOME/gdrive/projects\""
    exit 1
fi

# Load config
source "$CONFIG_FILE"

# Validate config
if [ -z "$LOCAL_DIR" ] || [ -z "$CLOUD_DIR" ]; then
    echo "Error: LOCAL_DIR and CLOUD_DIR must be set in $CONFIG_FILE"
    exit 1
fi

# Check if directories exist
if [ ! -d "$LOCAL_DIR" ]; then
    echo "Error: LOCAL_DIR '$LOCAL_DIR' does not exist."
    exit 1
fi

if [ ! -d "$CLOUD_DIR" ]; then
    echo "Error: CLOUD_DIR '$CLOUD_DIR' does not exist."
    echo "Check if your drive is mounted."
    exit 1
fi

# Check excludes file
if [ ! -f "$EXCLUDES_FILE" ]; then
    echo "Warning: Excludes file not found at $EXCLUDES_FILE"
fi

# Construct rclone command
CMD=(rclone bisync "$LOCAL_DIR" "$CLOUD_DIR")
CMD+=(--create-empty-src-dirs)
# Default fast check (size,modtime) is implied by bisync, strict checks added conditionally below
CMD+=(--resilient)
CMD+=(--recover)
CMD+=(--verbose)

if [ -f "$EXCLUDES_FILE" ]; then
    CMD+=(--exclude-from "$EXCLUDES_FILE")
fi

# Parse arguments for integrity flag
args=()
integrity_mode=false
for arg in "$@"; do
    if [ "$arg" == "--integrity" ]; then
        integrity_mode=true
    else
        args+=("$arg")
    fi
done

if [ "$integrity_mode" = true ]; then
    echo "ðŸ”’ Integrity Mode Enabled: Performing full checksum verification (Slow)..."
    CMD+=(--compare size,modtime,checksum)
    CMD+=(--slow-hash-sync-only)
else
    echo "âš¡ Speed Mode: Checking size and modtime only (Fast)..."
    # rclone bisync default is size,modtime
fi

# Pass through other arguments
CMD+=("${args[@]}")

echo "Syncing '$LOCAL_DIR' <-> '$CLOUD_DIR'..."
"${CMD[@]}"

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
echo "âœ… Sync completed in ${DURATION}s"
